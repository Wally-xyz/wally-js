{"version":3,"file":"wally-connector.js","sourceRoot":"","sources":["../src/wally-connector.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  MethodNameType,\n  MethodResponse,\n  PersonalSignParams,\n  RedirectOptions,\n  RequestObj,\n  RPCMethodName,\n  RPCMethodParams,\n  RPCResponse,\n  SignParams,\n  WallyConnectorOptions,\n  WallyMethodName,\n  WallyMethodParams,\n  WallyResponse,\n  WorkerMessage,\n} from './types';\n\nimport {\n  APP_ROOT,\n  REDIRECT_CAPTION_ID,\n  SCRIM_TEXT_ID,\n  getRedirectPage,\n  getScrimElement,\n  WALLY_ROUTES,\n} from './constants';\n\nclass WallyConnector {\n  private clientId: string | null;\n  private host: string | null;\n  private isDevelopment: boolean;\n  public selectedAddress: string | null;\n  private didHandleRedirect: boolean;\n  private worker: SharedWorker | null;\n  private workerCallbacks: Partial<Record<WorkerMessage, Array<() => void>>>;\n\n  constructor({ clientId, isDevelopment, devUrl }: WallyConnectorOptions) {\n    this.clientId = clientId;\n    this.host = (isDevelopment && devUrl) || APP_ROOT;\n    this.selectedAddress = null;\n    this.isDevelopment = !!isDevelopment;\n    this.didHandleRedirect = false;\n\n    // todo - make path configurable, node_modules maybe?\n    this.worker = SharedWorker ? new SharedWorker('/sdk/worker.js') : null;\n    this.connectToSharedWorker();\n    this.workerCallbacks = {};\n  }\n\n  private connectToSharedWorker(): void {\n    if (!this.worker) {\n      console.error(\n        'SharedWorker not available, falling back to less-than-ideal experience.'\n      );\n      return;\n    }\n\n    this.worker.port.start();\n    this.worker.port.onmessage = (e: MessageEvent) => {\n      this.handleWorkerMessage(e.data);\n    };\n  }\n\n  private handleWorkerMessage(message: WorkerMessage): void {\n    if (!this.worker) {\n      return;\n    }\n    this.workerCallbacks[message]?.forEach((cb) => cb());\n  }\n\n  private onWorkerMessage(message: WorkerMessage, fn: () => void) {\n    if (!this.worker) {\n      return;\n    }\n    if (!this.workerCallbacks[message]) {\n      this.workerCallbacks[message] = [];\n    }\n    this.workerCallbacks[message]?.push(fn);\n  }\n\n  public async loginWithEmail(): Promise<void> {\n    if (!this.clientId) {\n      console.error('Please set a client ID');\n      return;\n    }\n    const state = this.generateStateCode();\n    this.saveState(state);\n    const queryParams = new URLSearchParams({ clientId: this.clientId, state });\n\n    window.open(`${this.host}/oauth/otp?${queryParams.toString()}`, '_blank');\n\n    const scrim = getScrimElement();\n    document.body.appendChild(scrim);\n\n    return new Promise((resolve, reject) => {\n      const updateFailureScrim = () => {\n        const scrimText = document.getElementById(SCRIM_TEXT_ID);\n        scrimText\n          ? (scrimText.innerText =\n              'Error logging in. ☹️\\nPlease refresh and try again.')\n          : {};\n      };\n\n      this.onWorkerMessage(WorkerMessage.LOGIN_SUCCESS, () => {\n        if (!this.getAuthToken()) {\n          updateFailureScrim();\n          reject();\n          return;\n        }\n        resolve();\n        document.body.removeChild(scrim);\n      });\n      this.onWorkerMessage(WorkerMessage.LOGIN_FAILURE, () => {\n        updateFailureScrim();\n        reject();\n      });\n    });\n  }\n\n  public isRedirected(): boolean {\n    return this.getState() !== null;\n  }\n\n  public isLoggedIn(): boolean {\n    return !!this.getAuthToken();\n  }\n\n  public async handleRedirect({\n    closeWindow = false,\n    appendContent = false,\n  }: RedirectOptions): Promise<void> {\n    if (this.didHandleRedirect) {\n      return;\n    }\n    this.didHandleRedirect = true;\n\n    if (appendContent) {\n      document.body.appendChild(getRedirectPage());\n    }\n\n    const storedState = this.getState();\n    const queryParams = new URLSearchParams(window.location.search);\n    if (storedState && storedState !== queryParams.get('state')) {\n      this.deleteState();\n      if (this.isDevelopment) {\n        console.error('Invalid Wally state');\n      }\n    }\n    this.deleteState();\n    const authCode = queryParams.get('authorization_code');\n\n    let resp: Response;\n    let error = null;\n    const caption = document.getElementById(REDIRECT_CAPTION_ID);\n\n    try {\n      resp = await fetch(`${this.host}/oauth/token`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Accept: 'application/json',\n        },\n        body: JSON.stringify({\n          authCode,\n        }),\n      });\n      console.log({ resp });\n      if (resp && resp?.ok && resp?.status < 300) {\n        const data = await resp.json();\n        this.setAuthToken(data.token);\n      } else {\n        error = await resp.text();\n        console.error(\n          'The Wally server returned a non-successful response when exchanging authorization code for token'\n        );\n      }\n    } catch (err) {\n      error = err;\n      console.error(`Unable to fetch Wally access token: ${err}`);\n    }\n\n    if (error) {\n      this.deleteState();\n      this.worker\n        ? this.worker.port.postMessage(WorkerMessage.LOGIN_FAILURE)\n        : {};\n\n      if (caption) {\n        caption.innerText = `Error retreiving token.\\n${error.toString()}`;\n        caption.style.color = 'red';\n      }\n      return;\n    }\n\n    if (this.worker) {\n      this.worker.port.postMessage(WorkerMessage.LOGIN_SUCCESS);\n    }\n\n    caption\n      ? (caption.innerText =\n          'Success. You may now close this page and refresh the app.')\n      : {};\n\n    if (closeWindow) {\n      window.setTimeout(window.close, 1000);\n    }\n  }\n\n  private setAuthToken(authToken: string): void {\n    localStorage.setItem(`wally:${this.clientId}:token`, authToken);\n  }\n\n  private getAuthToken(): string | null {\n    return localStorage.getItem(`wally:${this.clientId}:token`);\n  }\n\n  private generateStateCode(length = 10) {\n    const chars = [];\n    for (let i = 0; i < 26; i++) {\n      chars.push(String.fromCharCode('a'.charCodeAt(0) + i));\n      chars.push(String.fromCharCode('A'.charCodeAt(0) + i));\n    }\n    for (let i = 0; i < 10; i++) {\n      chars.push('0'.charCodeAt(0) + i);\n    }\n\n    const authCode = [];\n    for (let charCount = 0; charCount < length; charCount++) {\n      const randInt = Math.floor(Math.random() * chars.length);\n      authCode.push(chars[randInt]);\n    }\n    return authCode.join('');\n  }\n\n  private saveState(state: string) {\n    localStorage.setItem(`wally:${this.clientId}:state:token`, state);\n  }\n\n  private getState(): string | null {\n    return localStorage.getItem(`wally:${this.clientId}:state:token`);\n  }\n\n  private deleteState() {\n    localStorage.removeItem(`wally:${this.clientId}:state:token`);\n  }\n\n  /**\n   * This is the major exposed method for supporting JSON RPC methods\n   * and associated wallet/blockchain functionality.\n   * There are two main types of requests: those that require wallet info\n   * (address, signing), and those that do not (gas prices, last block).\n   * We route the former to customized endpoints on the backend that handle\n   * this extra wallet fetching and logic, and the latter to an endpoint\n   * that essentially works as a passthrough to ethers/alchemy.\n   *\n   * TODO: Move requesting logic and helpers to separate file/module\n   * @param req\n   * @param req.method - the name of the RPC method\n   * @param req.params - the required parameters for the method\n   * @returns Promise<MethodResponse> | null\n   * @see https://ethereum.org/en/developers/docs/apis/json-rpc/#json-rpc-methods\n   */\n  async request<T extends MethodNameType>(\n    req: RequestObj<T>\n  ): Promise<MethodResponse<T> | null> {\n    if (!this.isLoggedIn()) {\n      await this.loginWithEmail();\n    }\n\n    if (Object.values(WallyMethodName).indexOf(req.method as any) > -1) {\n      return this.requestWally(\n        req.method as WallyMethodName,\n        'params' in req ? (req.params as WallyMethodParams<T>) : undefined\n      ) as Promise<WallyResponse<T>>;\n    } else if (Object.values(RPCMethodName).indexOf(req.method as any) > -1) {\n      return this.requestRPC(\n        req.method as RPCMethodName,\n        'params' in req ? (req.params as RPCMethodParams<T>) : undefined\n      );\n    } else {\n      throw new Error(`Method ${req.method} is unsupported at this time.`);\n    }\n  }\n\n  private formatWallyParams<T extends WallyMethodName>(\n    method: T,\n    params: WallyMethodParams<T>\n  ): string {\n    if (method === WallyMethodName.SIGN) {\n      return JSON.stringify({ message: (params as SignParams)[1] });\n    } else if (method === WallyMethodName.PERSONAL_SIGN) {\n      return JSON.stringify({ message: (params as PersonalSignParams)[0] });\n    } else {\n      return JSON.stringify(params);\n    }\n  }\n\n  private formatWallyResponse<T extends WallyMethodName>(\n    method: T,\n    data: any\n  ): WallyResponse<T> | null {\n    switch (method) {\n      case WallyMethodName.ACCOUNTS:\n      case WallyMethodName.REQUEST_ACCOUNTS: {\n        const { address } = data;\n        this.selectedAddress = address;\n        return [address] as WallyResponse<T>;\n      }\n      case WallyMethodName.SIGN:\n      case WallyMethodName.PERSONAL_SIGN:\n      case WallyMethodName.SIGN_TRANSACTION:\n      case WallyMethodName.SIGN_TYPED: {\n        const { signature } = data;\n        return signature;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Method used doing wallet-related actions like requesting accounts\n   * and signing things - actions that require wallet/private key access\n   * and are basically the core wally value prop.\n   * @param method The RPC method name associated with the wally api call\n   * @param params The json rpc spec params (*not* wally's spec)\n   * @returns WallyResponse - adheres to the json rpc spec\n   */\n  private async requestWally<T extends WallyMethodName>(\n    method: T,\n    params: WallyMethodParams<T>\n  ): Promise<WallyResponse<T> | null> {\n    let resp: Response;\n    try {\n      resp = await fetch(`${this.host}/oauth/${WALLY_ROUTES[method]}`, {\n        method: 'POST',\n        headers: {\n          Authorization: `Bearer ${this.getAuthToken()}`,\n          ...(method.indexOf('sign') > -1\n            ? { 'Content-Type': 'application/json' }\n            : {}),\n        },\n        ...(params &&\n          params.length > 0 && {\n            body: this.formatWallyParams(method, params),\n          }),\n      });\n      if (resp && resp?.ok && resp?.status < 300) {\n        const data = await resp.json();\n        return this.formatWallyResponse(method, data);\n      } else {\n        console.error(\n          `The Wally server returned a non-successful response when handling method: ${method}`\n        );\n      }\n    } catch (err) {\n      console.error(\n        `Wally server returned error: ${err} when handling method: ${method}`\n      );\n    }\n\n    return null;\n  }\n\n  /**\n   * Handle other non-wally-specific methods - forwards to ethers/alchemy\n   * on the backend\n   * @param method The RPC method name\n   * @param params The json rpc spec params\n   * @returns RPCResponse - adheres to the json rpc spec\n   */\n  private async requestRPC<T extends RPCMethodName>(\n    method: T,\n    params: RPCMethodParams<T>\n  ): Promise<RPCResponse<T> | null> {\n    console.log({ method, params });\n    try {\n      const resp = await fetch(`${this.host}/oauth/wallet/send`, {\n        method: 'POST',\n        headers: {\n          Authorization: `Bearer ${this.getAuthToken()}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          method,\n          params,\n        }),\n      });\n\n      if (!resp.ok || resp.status >= 300) {\n        throw new Error(\n          `Wally server returned a non-successful response when handling method: ${method}`\n        );\n      }\n\n      const contentType = resp.headers.get('content-type');\n      if (contentType && contentType.indexOf('application/json') !== -1) {\n        const json = await resp.json();\n        return json;\n      } else {\n        const text = await resp.text();\n        return text as RPCResponse<T>;\n      }\n    } catch (err) {\n      console.error(\n        `Wally server returned error: ${err} when handling method: ${method}`\n      );\n    }\n    return null;\n  }\n}\n\nexport default WallyConnector;\n"]}